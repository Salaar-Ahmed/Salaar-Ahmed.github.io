<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>For Sara Khan · my Valentine</title>
  <style>
    /* ===== CRAFTED WITH LOVE FOR SARA ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --whisper: #F2EAF7;
      --wisteria: #C59DD9;
      --velvet: #7A3F91;
      --sacred: #2B0D3E;

      /* transitions */
      --transition-slow: 1.2s cubic-bezier(0.2, 0.9, 0.3, 1);
      --transition-ceremony: 0.9s cubic-bezier(0.25, 0.46, 0.45, 0.94);

      /* typography */
      --font-serif: 'Georgia', 'Times New Roman', serif;
      --font-sans: 'Avenir', 'Segoe UI', 'Roboto', system-ui, sans-serif;

      /* glass effects */
      --glass-bg: rgba(242, 234, 247, 0.12);
      --glass-border: rgba(197, 157, 217, 0.25);
      --card-shadow: 0 30px 60px -20px rgba(43, 13, 62, 0.6), 0 0 0 1px rgba(197, 157, 217, 0.2) inset;
      
      /* spacing */
      --space-xs: 0.5rem;
      --space-sm: 0.8rem;
      --space-md: 1.2rem;
      --space-lg: 1.8rem;
      --space-xl: 2.2rem;
    }

    /* reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* base styles */
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--sacred);
      font-family: var(--font-sans);
      color: var(--whisper);
      padding: var(--space-sm);
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }

    /* breathing galactic gradient */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 40% 50%, var(--velvet) 0%, var(--sacred) 80%);
      filter: blur(8px);
      opacity: 0.9;
      z-index: -2;
      animation: galaxyBreath 12s infinite alternate ease-in-out;
    }

    @keyframes galaxyBreath {
      0% { transform: scale(1); opacity: 0.7; background: radial-gradient(circle at 30% 60%, #8a4ba0, #2B0D3E); }
      100% { transform: scale(1.08); opacity: 1; background: radial-gradient(circle at 60% 40%, #b47bc9, #351a47); }
    }

    /* film grain / light leak texture */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="1" stitchTiles="stitch"/><feColorMatrix type="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0.05 0"/></filter><rect width="100" height="100" filter="url(%23noise)" opacity="0.12"/></svg>');
      opacity: 0.1;
      pointer-events: none;
      z-index: -1;
      mix-blend-mode: overlay;
    }

    /* main canvas */
    .canvas {
      width: 100%;
      max-width: 420px;
      aspect-ratio: 9 / 16;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* venetian glass card */
    .card {
      width: 100%;
      height: 100%;
      background: var(--glass-bg);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border-radius: min(42px, 8vw) min(42px, 8vw) min(38px, 7vw) min(38px, 7vw);
      border: 1px solid var(--glass-border);
      box-shadow: var(--card-shadow);
      padding: clamp(1.2rem, 6vw, 2.2rem) clamp(1rem, 5vw, 1.8rem);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.5s, border-color 0.5s;
      position: relative;
      overflow: hidden;
    }

    /* particle field - dynamically generated */
    .particle-field {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(20px);
      opacity: 0.5;
      background: radial-gradient(circle at 30% 30%, var(--wisteria), rgba(197, 157, 217, 0.1));
      animation: floatOrb 16s infinite alternate ease-in-out;
    }

    @keyframes floatOrb {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(6%, 8%) scale(1.2); }
    }

    /* scene containers */
    .scene {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity var(--transition-slow), transform var(--transition-slow);
      position: relative;
      z-index: 5;
    }

    .scene--hidden {
      opacity: 0;
      transform: scale(0.96);
      pointer-events: none;
      position: absolute;
    }

    /* proposition typography */
    .proposition {
      text-align: center;
      width: 100%;
    }

    .greeting {
      font-family: var(--font-serif);
      font-weight: 400;
      font-size: clamp(1rem, 5vw, 1.8rem);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--wisteria);
      margin-bottom: var(--space-xs);
      opacity: 0.8;
      text-shadow: 0 0 12px rgba(197, 157, 217, 0.5);
    }

    .name {
      font-size: clamp(2rem, 10vw, 3.8rem);
      font-family: var(--font-serif);
      font-weight: 400;
      line-height: 1.1;
      color: var(--whisper);
      margin-bottom: var(--space-xs);
      text-shadow: 0 0 18px rgba(255, 240, 250, 0.6);
      letter-spacing: -0.01em;
      word-break: break-word;
    }

    .question {
      font-size: clamp(1rem, 4vw, 1.2rem);
      margin: var(--space-md) 0 var(--space-lg);
      font-style: italic;
      color: rgba(242, 234, 247, 0.9);
      border-top: 1px solid rgba(197, 157, 217, 0.3);
      border-bottom: 1px solid rgba(197, 157, 217, 0.3);
      padding: var(--space-sm) 0;
      max-width: min(280px, 80%);
      margin-left: auto;
      margin-right: auto;
      font-weight: 300;
      backdrop-filter: blur(4px);
    }

    /* gestures */
    .gestures {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: clamp(1.5rem, 8vw, 2.5rem);
      margin-top: var(--space-sm);
      width: 100%;
      flex-wrap: wrap;
    }

    .gesture {
      border: none;
      background: transparent;
      font-family: var(--font-serif);
      font-size: clamp(1.8rem, 7vw, 2.2rem);
      font-weight: 300;
      padding: clamp(0.3rem, 2vw, 0.4rem) clamp(0.5rem, 3vw, 1rem);
      cursor: pointer;
      transition: all var(--transition-ceremony);
      position: relative;
      color: var(--whisper);
      text-shadow: 0 0 10px currentColor;
      letter-spacing: 0.2rem;
      line-height: 1;
      border-radius: 4px;
    }

    .gesture:focus-visible {
      outline: 3px solid var(--wisteria);
      outline-offset: 4px;
      border-radius: 4px;
    }

    .gesture--yes {
      font-size: clamp(2.5rem, 9vw, 3.2rem);
      font-weight: 400;
      color: #fff;
      text-shadow: 0 0 24px var(--wisteria), 0 4px 12px rgba(122, 63, 145, 0.6);
    }

    .gesture--yes:hover,
    .gesture--yes:focus-visible {
      transform: scale(1.08);
      color: #ffffff;
      text-shadow: 0 0 32px #f2d3ff;
    }

    .gesture--no {
      font-size: clamp(1.6rem, 6vw, 2rem);
      color: rgba(242, 234, 247, 0.55);
      text-shadow: none;
      font-style: italic;
    }

    .gesture--no:hover,
    .gesture--no:focus-visible {
      color: var(--wisteria);
      text-shadow: 0 0 12px var(--velvet);
    }

    /* micro-response container */
    .micro-response {
      min-height: 70px;
      margin-top: var(--space-md);
      font-size: clamp(0.9rem, 3.5vw, 1.1rem);
      font-style: italic;
      color: var(--wisteria);
      opacity: 0;
      transition: opacity 0.9s ease, text-shadow 0.5s, transform 0.3s ease;
      text-align: center;
      padding: 0 var(--space-sm);
      letter-spacing: 0.03em;
      max-width: min(300px, 90%);
      transform: translateY(10px);
    }

    .micro-response--visible {
      opacity: 1;
      text-shadow: 0 0 16px #f0c4ff, 0 0 4px white;
      transform: translateY(0);
    }

    /* ===== SCENE 2 - LETTER WITH ENHANCEMENTS ===== */
    .letter {
      text-align: center;
      width: 100%;
      position: relative;
      z-index: 5;
    }

    /* Purple Flower - floating behind */
    .flower-orbit {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .purple-flower {
      width: min(200px, 50%);
      height: min(200px, 50%);
      background: radial-gradient(circle at 30% 30%, 
        rgba(197, 157, 217, 0.25) 0%, 
        rgba(122, 63, 145, 0.2) 40%, 
        transparent 70%);
      border-radius: 60% 40% 50% 50% / 40% 50% 50% 60%;
      filter: blur(6px) brightness(1.2);
      opacity: 0.6;
      animation: orbitFlower 20s infinite linear;
      transform-origin: center center;
      box-shadow: 
        0 0 30px rgba(197, 157, 217, 0.3),
        inset 0 0 40px rgba(242, 234, 247, 0.2);
      position: relative;
    }

    /* Flower petals effect */
    .purple-flower::before,
    .purple-flower::after {
      content: '';
      position: absolute;
      width: 80%;
      height: 80%;
      background: inherit;
      border-radius: 50%;
      filter: blur(8px);
      opacity: 0.5;
      top: 10%;
      left: 10%;
    }

    .purple-flower::after {
      width: 60%;
      height: 60%;
      top: 20%;
      left: 20%;
      background: radial-gradient(circle, rgba(197, 157, 217, 0.4), transparent);
    }

    @keyframes orbitFlower {
      0% {
        transform: rotate(0deg) translateX(15px) rotate(0deg) scale(0.9);
      }
      25% {
        transform: rotate(90deg) translateX(20px) rotate(-90deg) scale(1.1);
      }
      50% {
        transform: rotate(180deg) translateX(15px) rotate(-180deg) scale(0.95);
      }
      75% {
        transform: rotate(270deg) translateX(10px) rotate(-270deg) scale(1.05);
      }
      100% {
        transform: rotate(360deg) translateX(15px) rotate(-360deg) scale(0.9);
      }
    }

    /* Ribbon frames for letter */
    .ribbon-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 6;
    }

    .ribbon-corner {
      position: absolute;
      width: min(80px, 20%);
      height: min(80px, 20%);
      background: linear-gradient(135deg, 
        rgba(197, 157, 217, 0.25) 0%, 
        rgba(242, 234, 247, 0.15) 50%, 
        transparent 80%);
      filter: blur(1px);
      border-radius: 0 0 50% 0;
    }

    .ribbon-corner--tl {
      top: 0;
      left: 0;
      transform: rotate(0deg);
      border-top: 2px solid rgba(197, 157, 217, 0.3);
      border-left: 2px solid rgba(197, 157, 217, 0.3);
      border-radius: 0 0 80% 0;
    }

    .ribbon-corner--tr {
      top: 0;
      right: 0;
      transform: rotate(90deg);
      border-top: 2px solid rgba(197, 157, 217, 0.3);
      border-right: 2px solid rgba(197, 157, 217, 0.3);
      border-radius: 0 0 0 80%;
    }

    .ribbon-corner--bl {
      bottom: 0;
      left: 0;
      transform: rotate(270deg);
      border-bottom: 2px solid rgba(197, 157, 217, 0.3);
      border-left: 2px solid rgba(197, 157, 217, 0.3);
      border-radius: 0 80% 0 0;
    }

    .ribbon-corner--br {
      bottom: 0;
      right: 0;
      transform: rotate(180deg);
      border-bottom: 2px solid rgba(197, 157, 217, 0.3);
      border-right: 2px solid rgba(197, 157, 217, 0.3);
      border-radius: 80% 0 0 0;
    }

    /* Decorative ribbon edges */
    .ribbon-edge {
      position: absolute;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(197, 157, 217, 0.2) 20%, 
        rgba(242, 234, 247, 0.15) 50%, 
        rgba(197, 157, 217, 0.2) 80%, 
        transparent);
      height: 2px;
      width: 70%;
      left: 15%;
    }

    .ribbon-edge--top {
      top: 8px;
    }

    .ribbon-edge--bottom {
      bottom: 8px;
      transform: rotate(180deg);
    }

    .ribbon-edge--left {
      width: 2px;
      height: 70%;
      left: 8px;
      top: 15%;
      background: linear-gradient(180deg, 
        transparent, 
        rgba(197, 157, 217, 0.2) 20%, 
        rgba(242, 234, 247, 0.15) 50%, 
        rgba(197, 157, 217, 0.2) 80%, 
        transparent);
    }

    .ribbon-edge--right {
      width: 2px;
      height: 70%;
      right: 8px;
      top: 15%;
      background: linear-gradient(180deg, 
        transparent, 
        rgba(197, 157, 217, 0.2) 20%, 
        rgba(242, 234, 247, 0.15) 50%, 
        rgba(197, 157, 217, 0.2) 80%, 
        transparent);
    }

    /* Letter content (existing styles) */
    .letter-head {
      font-family: var(--font-serif);
      font-size: clamp(1.5rem, 6vw, 1.9rem);
      margin-bottom: 0.25rem;
      color: var(--whisper);
      text-shadow: 0 0 20px #b692cf;
      word-break: break-word;
      position: relative;
      z-index: 7;
    }

    .letter-sub {
      color: var(--wisteria);
      font-size: clamp(0.8rem, 3vw, 1rem);
      letter-spacing: 0.3rem;
      text-transform: uppercase;
      margin-bottom: clamp(1rem, 4vw, 2rem);
      word-break: break-word;
      position: relative;
      z-index: 7;
    }

    .letter-body {
      font-size: clamp(0.9rem, 3.5vw, 1.1rem);
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(43, 13, 62, 0.3);
      backdrop-filter: blur(8px);
      padding: clamp(1rem, 4vw, 1.8rem) clamp(0.8rem, 3vw, 1.2rem);
      border-radius: min(40px, 6vw) min(20px, 4vw) min(40px, 6vw) min(20px, 4vw);
      border: 1px solid rgba(197, 157, 217, 0.3);
      margin: var(--space-sm) 0 var(--space-xs);
      font-weight: 300;
      box-shadow: 0 15px 35px -10px black;
      position: relative;
      z-index: 7;
    }

    .dua {
      font-family: var(--font-serif);
      font-size: clamp(1rem, 4vw, 1.2rem);
      font-style: italic;
      color: #e8d1ff;
      background: rgba(122, 63, 145, 0.2);
      border-radius: min(60px, 10vw);
      padding: clamp(0.6rem, 3vw, 0.8rem) clamp(1rem, 4vw, 1.5rem);
      margin-top: var(--space-xs);
      backdrop-filter: blur(4px);
      border: 1px dashed var(--wisteria);
      line-height: 1.5;
      position: relative;
      z-index: 7;
    }

    /* shimmer effect */
    .shimmer-effect {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255, 230, 240, 0.3) 0%, transparent 60%);
      opacity: 0;
      transition: opacity 0.6s;
      z-index: 10;
      border-radius: inherit;
    }

    .shimmer-effect.active {
      opacity: 1;
    }

    /* audio player */
    .audio-player {
      position: absolute;
      bottom: clamp(10px, 4vh, 20px);
      right: clamp(10px, 4vw, 20px);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .audio-control {
      background: var(--glass-bg);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 8px 12px 8px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--card-shadow);
      transition: all var(--transition-ceremony);
      cursor: pointer;
      color: var(--whisper);
      font-size: 0.9rem;
    }

    .audio-control:hover {
      border-color: var(--wisteria);
      box-shadow: 0 0 15px rgba(197, 157, 217, 0.3);
    }

    .audio-control:focus-visible {
      outline: 3px solid var(--wisteria);
      outline-offset: 2px;
    }

    .play-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--velvet);
      border-radius: 50%;
      color: var(--whisper);
      font-size: 14px;
      transition: transform 0.3s ease;
    }

    .audio-control:hover .play-icon {
      transform: scale(1.1);
      background: var(--wisteria);
    }

    .track-name {
      font-family: var(--font-serif);
      font-size: clamp(0.7rem, 2.5vw, 0.85rem);
      opacity: 0.9;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ultra-small devices */
    @media (max-width: 320px) {
      :root {
        --space-xs: 0.3rem;
        --space-sm: 0.5rem;
        --space-md: 0.8rem;
        --space-lg: 1.2rem;
        --space-xl: 1.5rem;
      }
      
      .gestures {
        gap: 1rem;
      }
      
      .micro-response {
        min-height: 80px;
      }
      
      .audio-control {
        padding: 5px 8px 5px 12px;
      }
      
      .track-name {
        max-width: 80px;
      }
    }

    /* landscape orientation handling */
    @media (max-height: 600px) and (orientation: landscape) {
      .canvas {
        aspect-ratio: auto;
        max-height: 95vh;
      }
      
      .card {
        padding: var(--space-sm);
      }
      
      .letter-body {
        max-height: 40vh;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <div class="canvas">
    <div class="card" role="main" aria-label="Valentine's Day interactive card for Sara">
      <!-- floating orbs - dynamically generated -->
      <div class="particle-field" id="particleField" aria-hidden="true"></div>

      <!-- Scene 1: Proposition -->
      <div id="scene1" class="scene proposition" role="region" aria-labelledby="greetingText" aria-hidden="false">
        <div class="greeting" id="greetingText">for the one who holds my heart</div>
        <div class="name" aria-label="Sara Khan">Sara Khan</div>
        <div class="question" id="questionText">Will you be my Valentine?</div>

        <div class="gestures" role="group" aria-label="Response options">
          <button class="gesture gesture--yes" id="yesBtn" aria-label="Say yes to being Valentine" tabindex="0">YES</button>
          <button class="gesture gesture--no" id="noBtn" aria-label="Not ready yet, but that's okay" tabindex="0">NO</button>
        </div>

        <!-- micro-response container -->
        <div id="microResponse" class="micro-response" role="status" aria-live="polite" aria-atomic="true"></div>
      </div>

      <!-- Scene 2: Valentine's Letter with Ribbon and Flower -->
      <div id="scene2" class="scene scene--hidden letter" role="region" aria-labelledby="letterHead" aria-hidden="true">
        <!-- Purple Flower Orbiting Behind -->
        <div class="flower-orbit" aria-hidden="true">
          <div class="purple-flower"></div>
        </div>
        
        <!-- Ribbon Frame -->
        <div class="ribbon-frame" aria-hidden="true">
          <div class="ribbon-corner ribbon-corner--tl"></div>
          <div class="ribbon-corner ribbon-corner--tr"></div>
          <div class="ribbon-corner ribbon-corner--bl"></div>
          <div class="ribbon-corner ribbon-corner--br"></div>
          <div class="ribbon-edge ribbon-edge--top"></div>
          <div class="ribbon-edge ribbon-edge--bottom"></div>
          <div class="ribbon-edge ribbon-edge--left"></div>
          <div class="ribbon-edge ribbon-edge--right"></div>
        </div>
        
        <!-- Letter Content (existing) -->
        <div class="letter-head" id="letterHead">My dearest Sara</div>
        <div class="letter-sub">happy Valentine's Day</div>
        <div class="letter-body" role="article">
          Every moment with you feels like finding light in the softest places.<br>
          Your smile is my favourite prayer, your presence my truest home.<br>
          Today I celebrate you, and the love that grows between us.
        </div>
        <div class="dua" role="note" aria-label="Prayer for our future">
          May the One who brought us together keep our hearts intertwined.<br>
          I pray for a future where we walk side by side,<br>
          through every season, hand in hand, always.
        </div>
      </div>

      <!-- shimmer overlay -->
      <div id="shimmer" class="shimmer-effect" aria-hidden="true"></div>

      <!-- audio player -->
      <div class="audio-player">
        <button id="audioControl" class="audio-control" aria-label="Play background music" title="Play background music">
          <span class="play-icon" id="playIcon">▶</span>
          <span class="track-name" id="trackName">Die With A Smile</span>
        </button>
      </div>
      <audio id="bgMusic" loop preload="auto" crossorigin="anonymous">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    </div>
  </div>

  <script>
    (function() {
      "use strict";
      
      // DOM elements
      const elements = {
        scene1: document.getElementById('scene1'),
        scene2: document.getElementById('scene2'),
        yesBtn: document.getElementById('yesBtn'),
        noBtn: document.getElementById('noBtn'),
        micro: document.getElementById('microResponse'),
        shimmer: document.getElementById('shimmer'),
        particleField: document.getElementById('particleField'),
        audio: document.getElementById('bgMusic'),
        audioControl: document.getElementById('audioControl'),
        playIcon: document.getElementById('playIcon'),
        trackName: document.getElementById('trackName')
      };

      // State
      let constellationTimer = null;
      const TRANSITION_MS = 1200;
      let isPlaying = false;
      let audioInitialized = false;
      
      // Micro-responses pool
      const microResponses = [
        "Take all the time you need, my heart is patient.",
        "Even your hesitation feels gentle to me.",
        "No rush, Sara. I'll be here, always.",
        "Every moment waiting for you is sweet.",
        "Your presence is worth every moment of patience.",
        "The moon waits for no one, but I'll wait for you.",
        "Your hesitation only makes your presence more precious."
      ];

      // ===== PARTICLE SYSTEM =====
      function initParticles() {
        if (!elements.particleField) return;
        
        elements.particleField.innerHTML = '';
        
        const particles = [
          { top: '5%', left: '5%', width: 180, height: 180, duration: 18, color: '#d9b0e8', delay: 0 },
          { bottom: '10%', right: '0%', width: 240, height: 240, duration: 22, color: '#b887cf', opacity: 0.4, delay: -3 },
          { top: '30%', right: '15%', width: 110, height: 110, duration: 14, color: '#f2d9ff', delay: 0 }
        ];
        
        particles.forEach(config => {
          const orb = document.createElement('div');
          orb.className = 'orb';
          
          Object.assign(orb.style, {
            top: config.top || 'auto',
            left: config.left || 'auto',
            bottom: config.bottom || 'auto',
            right: config.right || 'auto',
            width: config.width + 'px',
            height: config.height + 'px',
            background: `radial-gradient(circle, ${config.color}, transparent 75%)`,
            opacity: config.opacity || 0.5,
            animationDuration: config.duration + 's',
            animationDelay: config.delay + 's'
          });
          
          elements.particleField.appendChild(orb);
        });
      }

      // ===== AUDIO CONTROL =====
      function initAudio() {
        if (!elements.audio || !elements.audioControl) return;
        
        if (elements.trackName) {
          elements.trackName.textContent = "Die With A Smile";
        }
        
        const playPromise = elements.audio.play();
        
        if (playPromise !== undefined) {
          playPromise.then(() => {
            isPlaying = true;
            if (elements.playIcon) elements.playIcon.textContent = '⏸';
            elements.audioControl.setAttribute('aria-label', 'Pause background music');
            elements.audioControl.setAttribute('title', 'Pause background music');
          }).catch(() => {
            isPlaying = false;
            if (elements.playIcon) elements.playIcon.textContent = '▶';
            elements.audioControl.setAttribute('aria-label', 'Play background music');
            elements.audioControl.setAttribute('title', 'Play background music');
          });
        }
        
        elements.audioControl.addEventListener('click', toggleAudio);
        
        elements.audio.addEventListener('ended', () => {
          if (isPlaying) {
            elements.audio.currentTime = 0;
            elements.audio.play();
          }
        });
        
        audioInitialized = true;
      }
      
      function toggleAudio() {
        if (!elements.audio) return;
        
        if (isPlaying) {
          elements.audio.pause();
          if (elements.playIcon) elements.playIcon.textContent = '▶';
          elements.audioControl.setAttribute('aria-label', 'Play background music');
          elements.audioControl.setAttribute('title', 'Play background music');
        } else {
          const playPromise = elements.audio.play();
          if (playPromise !== undefined) {
            playPromise.then(() => {
              if (elements.playIcon) elements.playIcon.textContent = '⏸';
              elements.audioControl.setAttribute('aria-label', 'Pause background music');
              elements.audioControl.setAttribute('title', 'Pause background music');
            }).catch(e => {
              console.log('Playback failed:', e);
            });
          }
        }
        isPlaying = !isPlaying;
      }

      // ===== SCENE MANAGEMENT =====
      function showScene(targetScene, hideScene) {
        if (targetScene === elements.scene2) {
          elements.scene1.setAttribute('aria-hidden', 'true');
          elements.scene2.setAttribute('aria-hidden', 'false');
        }
        
        targetScene.classList.remove('scene--hidden');
        
        void hideScene.offsetWidth;
        
        hideScene.style.opacity = '0';
        hideScene.style.transform = 'scale(0.96)';
        targetScene.style.opacity = '1';
        targetScene.style.transform = 'scale(1)';
        
        setTimeout(() => {
          if (hideScene.style.opacity === '0') {
            hideScene.classList.add('scene--hidden');
          }
        }, TRANSITION_MS * 0.8);
      }

      // ===== SHIMMER CONTROL =====
      function activateShimmer(event) {
        if (!elements.shimmer) return;
        
        if (event) {
          const rect = event.target.getBoundingClientRect();
          const x = ((rect.left + rect.width/2) / window.innerWidth) * 100;
          const y = ((rect.top + rect.height/2) / window.innerHeight) * 100;
          elements.shimmer.style.setProperty('--x', x + '%');
          elements.shimmer.style.setProperty('--y', y + '%');
        } else {
          elements.shimmer.style.setProperty('--x', '50%');
          elements.shimmer.style.setProperty('--y', '70%');
        }
        
        elements.shimmer.classList.add('active');
        
        if (constellationTimer) clearTimeout(constellationTimer);
        constellationTimer = setTimeout(() => {
          elements.shimmer.classList.remove('active');
        }, 1800);
      }

      function animateButton(button, scale = 1.08, color = 'var(--wisteria)') {
        if (!button) return;
        
        button.style.transform = `scale(${scale})`;
        if (color) button.style.color = color;
        
        setTimeout(() => {
          button.style.transform = 'scale(1)';
          button.style.color = '';
        }, 300);
      }

      function showMicroResponse() {
        if (!elements.micro) return;
        
        const randomIdx = Math.floor(Math.random() * microResponses.length);
        elements.micro.textContent = '✦ ' + microResponses[randomIdx] + ' ✦';
        elements.micro.classList.add('micro-response--visible');
      }

      function hideMicroResponse() {
        if (!elements.micro) return;
        elements.micro.classList.remove('micro-response--visible');
      }

      function handleYes() {
        if (elements.shimmer) elements.shimmer.classList.remove('active');
        hideMicroResponse();
        
        showScene(elements.scene2, elements.scene1);
        
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.textContent = 'Showing Valentine\'s letter for Sara';
        document.body.appendChild(announcement);
        setTimeout(() => announcement.remove(), 1000);
      }

      function handleNo(event) {
        if (elements.scene1.classList.contains('scene--hidden')) return;
        
        showMicroResponse();
        activateShimmer(event);
        animateButton(elements.noBtn);
      }

      function handleKeyDown(event) {
        if (event.key === 'Escape') {
          hideMicroResponse();
          if (elements.shimmer) elements.shimmer.classList.remove('active');
        }
        
        if (event.key === 'm' || event.key === 'M') {
          if (audioInitialized) {
            toggleAudio();
          }
        }
      }

      function init() {
        initParticles();
        initAudio();
        
        elements.scene1.style.opacity = '1';
        elements.scene1.style.transform = 'scale(1)';
        elements.scene2.style.opacity = '0';
        elements.scene2.style.transform = 'scale(0.96)';
        
        elements.scene1.setAttribute('aria-hidden', 'false');
        elements.scene2.setAttribute('aria-hidden', 'true');
        
        elements.yesBtn.addEventListener('click', handleYes);
        elements.noBtn.addEventListener('click', handleNo);
        
        document.addEventListener('keydown', handleKeyDown);
        
        window.addEventListener('touchstart', () => {}, { passive: true });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
